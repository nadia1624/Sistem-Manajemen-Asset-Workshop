<%- include("../../layout/sidebar.ejs") %>

<main class="content">
    <div class="header-content">
      <h3 style="font-weight: bold;">Penyerahan Aset</h3>
      <div class="search-bar" style="margin-right: 30px;">
        <input id="search-input" placeholder="Search..." type="text" onkeyup="filterTable()"/>
        <i class="fas fa-search"></i>
     </div>
    </div>
    <div class="container-fluid px-4">
      <div class="table-wrapper">
        <div class="table-responsive">
          <div class="table-bungkus">
            <div class="table-scroll">
              <table class="table-compact">
                <thead>
                  <tr>
                    <th width="5%">No</th>
                    <th width="13%">Nama</th>
                    <th width="13%">Unit Kerja</th>
                    <th width="14%">Nama Aset</th>
                    <th width="13%">Nama Penerima</th>
                    <th width="15%">Bukti Penyerahan</th>
                    <th width="15%">Status</th>
                    <th width="10%">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (listPenyerahan.length > 0) { %>
                    <% listPenyerahan.forEach((penyerahan, index) => { %>
                      <tr>
                        <td width="5%"><%= index + 1 %></td>
                        <td width="13%"><%= penyerahan.Permintaan.User.nama %></td>
                        <td width="13%"><%= penyerahan.Permintaan.User.unit_kerja %></td>
                        <td width="14%"><%= penyerahan.Permintaan.Aset.nama_barang %></td>
                        <td width="13%">
                          <% if (penyerahan.penerima) { %>
                            <%= penyerahan.penerima %>
                          <% } else { %>
                            -
                          <% } %>
                        </td>
                        <td width="15%">
                          <% if (penyerahan.gambar_bukti) { %>
                            <img class="img-fluid" alt="Bukti Penyerahan" src="/public/uploads/<%= penyerahan.gambar_bukti %>" />
                          <% } else { %>
                            <span>-</span>
                          <% } %>
                        </td>
                        <td width="17%">
                          <% if (penyerahan.status_penyerahan === "belum diserahkan") { %>
                            <span class="custom-span" style="background-color: #dd5f61; font: black;">Belum Diserahkan</span>
                          <% } else if (penyerahan.status_penyerahan === "sudah diserahkan") { %>
                            <span class="custom-span" style="background-color: #A2E180; font: black;">Telah Diserahkan</span>
                          <% } %>
                        </td>
                        <td width="10%">
                          <% if (penyerahan.status_penyerahan === "belum diserahkan") { %>
                            <button class="btn btn-setuju" 
                            style="background-color: #28a745; color: white;" 
                            onclick="showModal('<%= penyerahan.id %>', '<%= penyerahan.Permintaan.Aset.nama_barang %>', '<%= penyerahan.Permintaan.User.nama %>', '<%= penyerahan.Permintaan.User.unit_kerja %>')">
                      <i class="fas fa-check"></i>
                    </button>
                          <% } else if (penyerahan.status_penyerahan === "sudah diserahkan" && penyerahan.surat) { %>
                              <a href="/data/surat/<%= penyerahan.surat %>" target="_blank" 
                                 class="btn btn-action" 
                                 style="background-color: #ffffff; padding: 6px 10px; font-size: 25px; border: 2px solid #000; padding-right: 6px; border-radius: 8px; color: #000; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; height: auto;">
                                  <i class="fa-solid fa-download" style="font-size: 15px;"></i>
                              </a>
                          <% } %>
                      </td>                      
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr>
                      <td colspan="8" class="text-center">Tidak ada data penyerahan.</td>
                    </tr>
                  <% } %>
                </tbody>                
            </table>
            <div id="no-data-message"id="no-data-message" class="no-data-message">
                Data tidak ditemukan.
            </div>          
          </div>
        </div>
      </div>
    </div>
  </div>
</main>


<!-- Modal -->
<div id="addModal" class="popup-modal">
  <div class="modal-content">
      <span id="close" class="close-btn">&times;</span>
      <h3 id="modalTitle">Konfirmasi Penyerahan Aset</h3>
      <form id="penyerahanForm" enctype="multipart/form-data">
          <label for="namaKaryawan" class="left-label">Nama Peminjam</label>
          <input type="text" id="namaKaryawan" name="namaKaryawan" value="" readonly required />

          <label for="unitKerja" class="left-label">Unit Kerja</label>
          <input type="text" id="unitKerja" name="unitKerja" value="" readonly required />

          <label for="namaAset" class="left-label">Nama Aset</label>
          <input type="text" id="namaAset" name="namaAset" value="" readonly required />

          <label class="left-label">Penerima Aset:</label>
          <div class="radio-group">
              <label>
                  <input type="radio" id="penerimaKaryawan" name="jenisPenerima" value="karyawan" checked />
                  Yang bersangkutan
              </label>
              <label>
                  <input type="radio" id="penerimaLain" name="jenisPenerima" value="lain" />
                  Diwakilkan
              </label>
          </div>

          <div id="perwakilanInput" style="display: none;">
              <label for="namaPenerima" class="left-label">Nama Perwakilan:</label>
              <input type="text" id="namaPenerima" name="namaPenerima" placeholder="Nama perwakilan" />
          </div>

          <label for="gambarBukti" class="left-label">Bukti Penyerahan:</label>
          <input type="file" id="gambarBukti" name="gambar_bukti" class="form-control" accept="image/*" required />

          <div class="flex justify-center space-x-4">
              <button type="button" class="btn cancel-btn">Tidak</button>
              <button type="submit" class="btn finish-btn">Ya</button>
          </div>
      </form>
  </div>
  <!-- Loading spinner -->
  <div id="loading" class="loading-container" style="display: none;">
    <div class="spinner"></div>
    <p>Proses sedang berlangsung...</p>
  </div>
</div>
  
<script>
  const modal = document.getElementById("addModal");
const closeBtn = document.getElementById("close");
const cancelBtn = document.querySelector(".cancel-btn");
const penyerahanForm = document.getElementById("penyerahanForm");
const penerimaKaryawan = document.getElementById("penerimaKaryawan");
const penerimaLain = document.getElementById("penerimaLain");
const perwakilanInput = document.getElementById("perwakilanInput");
const namaPenerimaInput = document.getElementById("namaPenerima");
const namaKaryawanInput = document.getElementById("namaKaryawan");

function showModal(id, namaAset, namaKaryawan, unitKerja) {
    modal.style.display = "flex";

    document.getElementById("namaKaryawan").value = namaKaryawan;
    document.getElementById("unitKerja").value = unitKerja;
    document.getElementById("namaAset").value = namaAset;
    penyerahanForm.dataset.id = id;
}

function togglePenerima() {
    if (penerimaLain.checked) {
        perwakilanInput.style.display = "block";
        namaPenerimaInput.setAttribute("required", "true");
    } else {
        perwakilanInput.style.display = "none";
        namaPenerimaInput.removeAttribute("required");
        namaPenerimaInput.value = "";
    }
}

penerimaKaryawan.addEventListener("change", togglePenerima);
penerimaLain.addEventListener("change", togglePenerima);

closeBtn.onclick = function () {
    modal.style.display = "none";
};

cancelBtn.onclick = function () {
    modal.style.display = "none";
};

window.onclick = function (event) {
    if (event.target === modal) {
        modal.style.display = "none";
    }
};

penyerahanForm.onsubmit = async function (event) {
    event.preventDefault();
    const formData = new FormData(penyerahanForm);
    const id = penyerahanForm.dataset.id;

    // Menampilkan spinner loading
    document.getElementById("loading").style.display = "flex";

    // Pastikan untuk menambahkan data penerima dan status diwakilkan
    if (document.getElementById("penerimaKaryawan").checked) {
        formData.append("nama_perwakilan", "");
        formData.append("isDiwakilkan", "false");
    } else {
        const namaPerwakilan = document.getElementById("namaPenerima").value;
        formData.append("nama_perwakilan", namaPerwakilan);
        formData.append("isDiwakilkan", "true");
    }

    try {
        const response = await fetch(`/penyerahanAset/${id}`, {
            method: "PATCH",
            body: formData,
        });

        const result = await response.json();

        // Sembunyikan loading sebelum menampilkan alert, dengan sedikit delay agar tampilan diperbarui dulu
        document.getElementById("loading").style.display = "none";

        setTimeout(() => {
            if (response.ok) {
                alert(result.message);
                location.reload();
            } else {
                alert(`Error: ${result.error}`);
            }
        }, 100); // Delay 100ms agar browser bisa menyegarkan tampilan sebelum alert
    } catch (error) {
        console.error("Terjadi kesalahan:", error);
        
        // Sembunyikan loading sebelum menampilkan alert
        document.getElementById("loading").style.display = "none";

        setTimeout(() => {
            alert("Terjadi kesalahan saat menyerahkan aset. Silakan coba lagi.");
        }, 100);
    } finally {
        // Pastikan modal juga ditutup setelah proses selesai
        modal.style.display = "none";
    }
};

function filterTable() {
    const input = document.getElementById("search-input").value.toLowerCase();
    const rows = document.querySelectorAll(".table-compact tbody tr");
    let hasMatch = false;

    rows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        if (rowText.includes(input)) {
            row.style.display = "";
            hasMatch = true;
        } else {
            row.style.display = "none";
        }
    });

    const noDataMessage = document.getElementById("no-data-message");
    if (hasMatch) {
        noDataMessage.style.opacity = "0";
        setTimeout(() => { noDataMessage.style.display = "none"; }, 300);
    } else {
        noDataMessage.style.display = "block"; 
        setTimeout(() => { noDataMessage.style.opacity = "1"; }, 50);
    }
}

</script>