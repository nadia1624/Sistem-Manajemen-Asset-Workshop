<body>
  <%- include('../../layout/header.ejs') %>

  <style>
    th:nth-child(1), td:nth-child(1) { width: 5%; }
    th:nth-child(2), td:nth-child(2) { width: 10%; }
    th:nth-child(3), td:nth-child(3) { width: 15%; }
    th:nth-child(4), td:nth-child(4) { width: 25%; }
    th:nth-child(5), td:nth-child(5) { width: 10%; }
    th:nth-child(6), td:nth-child(6) { width: 10%; }
    th:nth-child(7), td:nth-child(7) { width: 15%; }
    th:nth-child(8), td:nth-child(8) { width: 10%; }
  </style>

  <main class="content">
    <div class="container-fluid px-4">
      <div class="table-wrapper">
        <div class="table-responsive">
          <div class="table-bungkus">
            <div class="table-scroll">
              <table class="table-compact">
                <thead>
                  <tr>
                    <th>No</th>
                    <th>Tanggal</th>
                    <th>Nama Aset</th>
                    <th>Deskripsi</th>
                    <th>Gambar</th>
                    <th>Kategori</th>
                    <th>Status</th>
                    <th>Aksi</th>
                </tr>
            </thead>
          <tbody>
           <% listPermintaan.forEach((permintaan, index) => { %>
              <tr>
                  <td><%= index + 1 %></td>
                  <td><%= permintaan.tanggal_permintaan %></td>
                  <td><%= permintaan.Aset.nama_barang %></td>
                  <td><%= permintaan.Aset.Kategori.deskripsi %></td>
                  <td>
                      <img class="img-fluid" alt="Gambar Aset" src="<%= permintaan.Aset.Kategori.gambar %>"/>
                  </td>
                  <td><%= permintaan.Aset.Kategori.nama_kategori %></td>
                  <td width="15%">
                    <% if (permintaan.status_permintaan === "diterima") { %>
                        <div class="status-badge disetujui">Disetujui</div>
                    <% } else if (permintaan.status_permintaan === "ditolak") { %>
                        <div class="status-badge ditolak">Ditolak</div>
                    <% } else if (permintaan.status_permintaan === "diproses") { %>
                        <div class="status-badge diproses">Diproses</div>
                    <% } %>
                </td>
                  <td>
                      <% if (permintaan.status_permintaan === "diterima") { %>
                        <button class="btn btn-upload" onclick="openModal('uploadModal')">
                          <i class="fa-solid fa-arrow-up-from-bracket"></i>Upload TTD
                        </button>
                      <% } else if (permintaan.status_permintaan === "diproses") { %>
                        <button class="btn btn-batal" onclick="openModal('cancelModal', '<%= permintaan.id %>')">
                          <i class="fa-solid fa-circle-xmark"></i>Batalkan
                        </button>
                      <% } %>
                       </td>                                  
                      </tr>
                   <% }); %>
                </tbody>
               </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>


<!-- Modal Pop-Up Tanda Tangan -->
<div id="uploadModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('uploadModal')">&times;</span>
    <h3>Upload Tanda Tangan</h3>
    <form id="uploadForm" enctype="multipart/form-data">
      <label for="signatureInput">Pilih file tanda tangan:</label>
      <input type="file" id="signatureInput" accept="image/*" required />
      <input type="hidden" id="permintaanId" /> <!-- Hidden field untuk permintaanId -->
      <div class="modal-actions">
        <button type="button" class="btn cancel-btn" onclick="closeModal('uploadModal')">Batal</button>
        <button type="button" class="btn finish-btn" onclick="submitUpload()">Upload</button>
      </div>
    </form>
  </div>
</div>


  <!-- Modal Pop-Up Cancel Permintaan -->
  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('cancelModal')">&times;</span>
      <h3>Konfirmasi Pembatalan</h3>
      <p>Apakah Anda yakin ingin membatalkan permintaan ini?</p>
      <div class="modal-actions">
        <button type="button" class="btn cancel-btn"  onclick="closeModal('cancelModal')">Tidak</button>
        <button type="submit" class="btn finish-btn" onclick="confirmCancel()">Ya</button>
      </div>
    </div>
  </div>


  <script>
    // Fungsi untuk membuka modal dan menyimpan ID permintaan
function openModal(modalId, permintaanId = null) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'flex';

  if (modalId === 'cancelModal' && permintaanId) {
    // Simpan ID permintaan di atribut data-permintaan-id
    modal.setAttribute('data-permintaan-id', permintaanId);
  }
}

// Fungsi untuk menutup modal
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'none';
}

async function submitUpload() {
  const permintaanId = document.getElementById('permintaanId').value;
  const fileInput = document.getElementById('signatureInput');
  const formData = new FormData();

  // Menambahkan file dan permintaanId ke FormData
  formData.append('file', fileInput.files[0]);
  formData.append('permintaanId', permintaanId);

  try {
    const response = await fetch('/karyawan/penyerahan/uploadTandaTangan', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();
    alert(result.message || "Tanda tangan berhasil diupload");

    if (response.ok) {
      closeModal('uploadModal');
      window.location.reload(); // Reload halaman untuk melihat update
    }

  } catch (error) {
    console.error("Error saat upload tanda tangan:", error);
    alert("Terjadi kesalahan saat upload tanda tangan.");
  }
}

// Fungsi untuk menghandle penghapusan permintaan
async function confirmCancel() {
  const cancelModal = document.getElementById('cancelModal');
  const permintaanId = cancelModal.getAttribute('data-permintaan-id');

  try {
    const response = await fetch(`/karyawan/permintaanAset/${permintaanId}`, {
      method: 'DELETE',
    });

    if (response.ok) {
      alert("Permintaan berhasil dibatalkan.");
      window.location.reload(); // Refresh halaman
    } else {
      const result = await response.json();
      alert(result.message || "Gagal membatalkan permintaan.");
    }
  } catch (error) {
    console.error("Error saat membatalkan permintaan:", error);
    alert("Terjadi kesalahan saat membatalkan permintaan.");
  } finally {
    closeModal('cancelModal');
  }
}

// Menutup modal jika user mengklik di luar modal
window.onclick = function (event) {
  const cancelModal = document.getElementById('cancelModal');
  if (event.target === cancelModal) {
    closeModal('cancelModal');
  }
};

  </script>
  

</body>
</html>